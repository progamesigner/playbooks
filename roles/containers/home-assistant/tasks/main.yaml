- name: Install packages
  ansible.builtin.package:
    name: "{{ item }}"
    install_recommends: no
    update_cache: yes
  loop:
  - bluez
  - dbus-broker

- name: Start services
  ansible.builtin.service:
    enabled: yes
    name: "{{ item }}"
    state: started
  loop:
  - dbus-broker

- name: Copy files
  ansible.builtin.copy:
    src: configuration.yaml
    dest: /srv/home-assistant/configuration.yaml

- name: Install addons
  ansible.builtin.include_tasks: addon.yaml
  loop:
  - https://github.com/cnstudio/Taipower-Bimonthly-Energy-Cost-homeassistant/archive/refs/tags/v0.51.8.tar.gz
  - https://github.com/osk2/panasonic_smart_app/archive/refs/tags/v2.4.0.tar.gz

- name: Start Home Assistant container
  shell: |
    if [ -n "$(docker container list --all --quiet --filter name=home-assistant)" ]; then
      docker container stop home-assistant
      docker container rm -v home-assistant
    fi

    docker container run \
      --detach \
      --env TZ={{ system_timezone }} \
      --name home-assistant \
      --network host \
      --restart unless-stopped \
      --volume /run/dbus:/run/dbus:ro \
      --volume /srv/home-assistant:/config \
      ghcr.io/home-assistant/home-assistant:2023.1.7
